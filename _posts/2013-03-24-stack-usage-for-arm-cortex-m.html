---
layout: post
title: "Stack usage for ARM Cortex-M"
date: 2013-03-24
comments: true
categories:
 - embedded
---

<div class='post'>
I'll present how I used one of the methods to measure stack usage, not using any plugin, just debugger and memory window.<br /><br />Methods to use:<br />1. IDE plugins (usually compiler and linker do the job)<br />2. Fill pattern (add small assembly routine in startup)<br />3. Take an address of the stack pointer in the main function, and in the most nested function (for a simple application usable) <br /><br /><br /><a href="http://www.iar.com/Global/Resources/Developers_Toolbox/Building_and_debugging/Controlling%20the%20stack%20size.pdf">IAR stack plugin [www.iar.com]</a><br />This document is targeted to IAR stack plugin. Although this did not work for the MCU I debugged.<br /><br /><a href="http://www.iar.com/Global/Resources/Developers_Toolbox/Building_and_debugging/Mastering_stack_and_heap_for_system_reliability.pdf">Stack and Heap [www.iar.com]</a><br />What's stack, heap, methods explained briefly how to calculate stack usage in IAR. Methods applicable for other IDE's as well, not limited to IAR only.<br /><br /><a href="http://www.keil.com/support/man/docs/armcc/armcc_CJAIIDCG.htm">Stack use in C and C++ [www.keil.com]</a><br />How to obtain stack usage in KEIL using callgraph (option --callgraph).<br />Here's callgraph output which I found on the internet, not needed to share mine:<br /><a href="ftp://ftp.analog.com/pub/MicroConverter/ADuC703x/EVAL_ADuC7036/code/Keil%20Example%20Code/PSM/PSM.htm">Keil callgraph - an example [ftp.analog.com/pub/MicroConverter]</a><br /><br />Using indirect calls (function pointers) make this method unreliable, same for IAR stack plugin, where it can be added #pragma calls, but what if an application using another library, that's too much changes to do, more simple approach is in a following paragraph presented, a filling memory for a stack with a pattern and show how low it gets.<br /><br /><a href="http://www.keil.com/forum/21045/">KEIL stack initialize routine [www.keil.com/forum]</a><br />Stack initialization routine, which I only accustomed to Thumb-2. Here's the code used on Cortex-M0. Label __user_initial_stackheap is located in assembly file for your board. Just run your application for a while and check the memory window to obtain the lowest address of the last character of your pattern (in our case it's AA (char values)). Calculate the subtraction which gives your application stack usage.<br /><br /><pre class="brush: python">__user_initial_stackheap<br />    LDR     R0, =Stack_Mem<br />    LDR     R1, =Stack_Size           <br />    LDR     R2, =0xAAAAAAAA<br />fill             <br />    STR     R2, [R0]<br />    ADDS    R0,#4<br />    SUBS    R1,#4                     <br />    BNE     fill<br /></pre><br />This also can be added in assembly file which is used in IAR or any other IDE, just replace Stack_Mem symbol (beginning of the stack) and Stack_Size (size of the stack).</div>
