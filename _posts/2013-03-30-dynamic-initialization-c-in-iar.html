---
layout: post
title: "Dynamic initialization C++ in IAR"
date: 2013-03-30
comments: true
categories:
 - C/C++
---

<div class='post'>
I've been running my demo application only in KEIL for few days which I believe was huge mistake which reflected on me on Friday. When I finally run it in IAR. Once it loaded, first object's method ended up in a default isr handler with the hard fault. My debug session started. First problem I found, was one function was overwritting memory, that one was simple to catch once I found out which memory and what object is located right before overwritten data. Second one was a bit tougher to find out.<br /><br />I decided to move local user-type objects to a global scope, which means before an application hits main function, global objects must be initialized. No problem with KEIL, but IAR did not do it.<br /><br />This is quote from EWARM Development Guide (IAR) [3] which is quite comprehensive manual to understand many options it offers through command line options. But it does not provide details which might be handy.<br /><b>When using the IAR C/C++ compiler and the standard library, C++ dynamic<br />initialization is handled automatically.</b><br /><br />I though all right, how to track it down and see if dynamic allocation is really executed. Let's check map file of my application:<br /><br /><pre class="brush: python">INIT TABLE<br />          Address     Size<br />          -------     ----<br />Zero (__iar_zero_init3)<br />    1 destination range, total size 0x2a7:<br />          0x1ffff420  0x2a7<br />Extra (__iar_cstart_call_ctors)<br /></pre><br />And here's ENTRY LIST of our interest:<br /><br /><pre class="brush: python">__call_ctors            0x00004775   0x18  Code  Gb  cppinit.o [4]<br />__iar_cstart_call_ctors<br />                        0x00004ae5   0x20  Code  Gb  cmain_call_ctors.o [7]<br /></pre><br />A problem is, they are not invoked, startup function just takes care regular things (copying initialized data from ROM to RAM, .bss data, vector table). There's nothing with dynamic initialization. I placed breakpoint inside __call_ctors and it surprisingly was not reached. How to invoke __call_ctors function? What's it declaration? Exactly this details is not in any documentation provided in IAR doc folder (at least I was not able to find it there). Only one link on google was relevant, let's test it.<br /><br /><pre class="brush: python">extern void * __iar_cstart_call_ctors(void *ptr);<br /></pre><br />No linker errors, correct declaration. Only one parameter, what it should be? The linker created following sections which are the one we are looking for (more info find in section C++ DYNAMIC INITIALIZATION [3] :<br /><br /><pre class="brush: python">.init_array$$Base       0x00004d58          --   Gb  - Linker created -<br />.init_array$$Limit      0x00004d5c          --   Gb  - Linker created -</pre><pre class="brush: python">&nbsp;</pre><pre class="brush: python">SHT$$INIT_ARRAY$$Base   0x00004d58          --   Gb  - Linker created -<br />SHT$$INIT_ARRAY$$Limit  0x00004d5c          --   Gb  - Linker created -<br />SHT$$PREINIT_ARRAY$$Base<br />                        0x00004d58          --   Gb  - Linker created -<br />SHT$$PREINIT_ARRAY$$Limit<br />                        0x00004d58          --   Gb  - Linker created -<br /></pre><br />Each section (INIT_ARRAY, PRE_INIT_ARRAY) contain array of pointers to initialization functions. [2] Let's invoke it in the end of an application's startup with a following line:<br /><br /><pre class="brush: python">void *cpp_init = __section_begin(".init_array");</pre><pre class="brush: python">__iar_cstart_call_ctors(cpp_init);</pre><br />That calls __call_ctors which initializes all global dynamic objects. Thus application works. An unanswered question is why it was not invoked automatically? I hope I'll come with an answer soon :)<br /><br />References:<br /><a href="http://code.google.com/p/sdp-firmwares/source/browse/SPILoader/SRC/cmain.s?r=18">[1] cmain.s [http://code.google.com/p/sdp-firmwares]</a><br /><a href="http://www.sco.com/developers/gabi/latest/contents.html">[2] System V Application Binary Interface [sco.com/developers/gabi]</a><br />[3] EWARM Development Guide - IAR installation folder/arm/doc or online</div>
