---
layout: post
title: "How to flash/debug KL05 with mbed library offline in KEIL (tutorial)"
date: 2013-09-12
comments: true
categories:
 - mbed
---

<div class='post'>
Hello,<br /><br />I finally allocated one evening to finish what I should have done earlier. I did not anticipate that at this time KL05 wouldn't be online on mbed (no mbed interface for this board yet). This is step guide how to debug it with free version of KEIL (I'll add ARM GCC later).<br /><br /><b>1. step - clone mbed git repository from github</b><br />mbed git repository is here mbed git repository [github.com]<br />If you don't use git, or github, download repository as zip file. This is crucial for offline debugging.<br /><br />Create a new file named private_settings.py in mbed/workspace_tools. Put the following source code there (I am using KEIL 4.6 at the moment, KEIL seldomly changes their folder structure).<br /><br /><br /><pre class="brush: python">from os.path import join<br /><br />ARM_PATH = "C:/Program Files/Keil/TAD/ARM"<br />ARM_BIN = join(ARM_PATH,"ARMCC","bin")<br />ARM_INC = join(ARM_PATH,"RV31","INC")<br />ARM_LIB    = join(ARM_PATH,"ARMCC","lib")<br />ARM_CPPLIB = join(ARM_PATH, "ARMCC","lib","cpplib")<br /><br />BUILD_OPTIONS = ["debug-info"] <br /></pre><br />Time to build our own mbed library, type on your command line&nbsp;<i>python build.py -m KL05Z -t ARM</i> from workspace_tool directory.<br /><br />If everything went ok, the output should state Build successes: * ARM::KL05Z. Built library is now inside build folder (same level than workspace_tools and libraries folders).<br /><br /><b>2. step - create KEIL project</b><br /><br />Create new folder (I name mine KL05_demo) and copy there entire folder mbed which is inside build directory. Open KEIL, select Project on the top toolbar and create a new project inside our new created directory. It asks you to choose a processor, MKL05Z32xxx4 is assembled on the freedom KL05Z.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-v00ln2LU8Xw/UjIoCiPM0LI/AAAAAAAAC7Y/JIz_JNO8-W4/s1600/kl05_tutorial_01.JPG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="235" src="http://1.bp.blogspot.com/-v00ln2LU8Xw/UjIoCiPM0LI/AAAAAAAAC7Y/JIz_JNO8-W4/s320/kl05_tutorial_01.JPG" width="320" /></a></div><br /><br />Click OK, it ask if you want to copy startup file, click No. We don't need it. This should be an output inside the Project window<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-zQe_F3aQ6N4/UjIoCn_ydiI/AAAAAAAAC8U/BXDWsxEMOig/s1600/kl05_tutorial_02.JPG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-zQe_F3aQ6N4/UjIoCn_ydiI/AAAAAAAAC8U/BXDWsxEMOig/s1600/kl05_tutorial_02.JPG" /></a></div><br />Remove that Source Group 1. <br /><br /><b>3. step - main code file</b><br />Create new main.cpp inside the project directory and paste there the simple demo. Here's my code:<br /><br /><pre class="brush: python">#include "mbed.h"<br /><br />DigitalOut myled(LED1);<br /><br />int main() {<br />    while(1) {<br />        myled = 1;<br />        wait(0.2);<br />        myled = 0;<br />        wait(0.2);<br />    }<br />}<br /></pre><br /><b>4. step - Set our new created project for KL05Z</b><br />The tab which we start with, it's User. Add there&nbsp;<i>fromelf --bin -o test05_KL05Z.bin test05.axf</i><br />This step can be skipped because KL05Z does not have the mbed interface yet. Once it does, this command creates a .bin file which you can copy to a mbed drive.<i> </i><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-IFJvaqH0OS0/UjIoC1RuDXI/AAAAAAAAC7o/aA3_dqXc10U/s1600/kl05_tutorial_03.JPG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="233" src="http://2.bp.blogspot.com/-IFJvaqH0OS0/UjIoC1RuDXI/AAAAAAAAC7o/aA3_dqXc10U/s320/kl05_tutorial_03.JPG" width="320" /></a></div><br /><br /><b>5.step - C/C++ tab</b><br />Fill Define with<br /><i>TARGET_KL05Z, NDEBUG, TOOLCHAIN_ARM, __CMSIS_RTOS, __CORTEX_M0PLUS</i><br /><br />The include paths should contain folders (add folder with the first icon, a small rectangle):<br /><i>mbed</i><br /><i>mbed/TARGET_KL05Z</i><br /><i>mbed/TARGET_KL05Z/TOOLCHAIN_ARM_STD</i><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-OmP0fBVXjVk/UjIoDJ1WyEI/AAAAAAAAC7w/YzOSrypMbK4/s1600/kl05_tutorial_04.JPG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="202" src="http://3.bp.blogspot.com/-OmP0fBVXjVk/UjIoDJ1WyEI/AAAAAAAAC7w/YzOSrypMbK4/s320/kl05_tutorial_04.JPG" width="320" /></a></div><br />The misc Controls should contain --gnu command.<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-uCG71P0yVYc/UjIoDYGAJmI/AAAAAAAAC74/RvX0JTomn00/s1600/kl05_tutorial_05.JPG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="232" src="http://1.bp.blogspot.com/-uCG71P0yVYc/UjIoDYGAJmI/AAAAAAAAC74/RvX0JTomn00/s320/kl05_tutorial_05.JPG" width="320" /></a></div><br />The asm tab should also have filled same Include Paths as C/C++. Copy them there.<br /><br /><b>6. step - Linker tab</b><br />Uncheck Memory Layout from Target Dialog. We need to add scatter file which is located inside <i>mbed/TARGET_KL05/TOOLCHAIN_ARM_STD</i>, named MKL05Z4.sct. Add it there.<br />This is what it should display : <i>.\mbed\TARGET_KL05Z\TOOLCHAIN_ARM_STD\MKL05Z4.sct</i><br /><br />Add precompiled mbed files to Misc controls which is right below Scatter file:<br /><i>mbed/TARGET_KL05Z/TOOLCHAIN_ARM_STD/sys.o</i><br /><i>mbed/TARGET_KL05Z/TOOLCHAIN_ARM_STD/retarget.o</i><br /><i>mbed/TARGET_KL05Z/TOOLCHAIN_ARM_STD/cmsis_nvic.o</i><br /><i>mbed/TARGET_KL05Z/TOOLCHAIN_ARM_STD/system_MKL05Z4.o</i><br /><i>mbed/TARGET_KL05Z/TOOLCHAIN_ARM_STD/startup_MKL05Z4.o</i><br /><i>mbed/TARGET_KL05Z/TOOLCHAIN_ARM_STD/mbed.ar</i><br /><br /><b>7. step - Debug tab</b><br />Now select the right radio button Use and select from drop-down menu CMSIS-DAP<br /><br /><b>8. step - Utilities</b><br />Same applies for Use Target Driver for Flash Programming - CMSIS-DAP. Click on Settings and verify everything is set according to target.<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-9NwF5NRhr0k/UjIoD8hXOnI/AAAAAAAAC8A/dRCHbdH-o-k/s1600/kl05_tutorial_06.JPG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="216" src="http://3.bp.blogspot.com/-9NwF5NRhr0k/UjIoD8hXOnI/AAAAAAAAC8A/dRCHbdH-o-k/s320/kl05_tutorial_06.JPG" width="320" /></a></div><br /><br /><b>10. step - adding sources</b><br />Create new group (I name it sources) and click with your right mouse button on the group and select Add files to group .... Here's my workspace.<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-3w9jt028Aoo/UjIoEByWpfI/AAAAAAAAC8Q/wY5a4X7SHLA/s1600/kl05_tutorial_07.JPG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="208" src="http://2.bp.blogspot.com/-3w9jt028Aoo/UjIoEByWpfI/AAAAAAAAC8Q/wY5a4X7SHLA/s320/kl05_tutorial_07.JPG" width="320" /></a></div><br /><br />Now it is finally time to compile, if you followed my steps, you should get no errors ! The picture below shows window after reflashing my KL05Z, part starting with a line LOAD "C...." it's a flashing part.<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-_kHtbg-QIJM/UjIoEZfXdwI/AAAAAAAAC8E/TccP-MDd_g8/s1600/kl05_tutorial_08.JPG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="114" src="http://4.bp.blogspot.com/-_kHtbg-QIJM/UjIoEZfXdwI/AAAAAAAAC8E/TccP-MDd_g8/s320/kl05_tutorial_08.JPG" width="320" /></a></div><br />We can't proceed with a bin file, due to a lack of mbed interface for our board. But CMSIS-DAP allows us to flash/debug it. Before we proceed to a debugging part, if your KL05 has not been flashed with CMSIS-DAP firmware, download it from freescale webpage - <i><a href="http://cache.freescale.com/files/32bit/software/board_support_packages/FRDM-KL05Z_QSP.zip?fpsp=1">FRDM-KL05Z_QSP.zip</a> </i>(quick start package). There's CMSIS-DAP_OpenSDA.S19 file inside OpenSDA Applications folder. I set my board to bootloader mode and flash it with this file. Reconnect your board, and let's flash it.<br /><br />Build (F7) and download your code (LOAD icon on top). This flashes KL05Z and LED should be blinking. If you want to debug it , press Ctrl+F5 (or top selection Debug -&gt; Start/stop debuging session). Happy flashing your KL05!<br /><br />If anything not clear, leave a comment.</div>
