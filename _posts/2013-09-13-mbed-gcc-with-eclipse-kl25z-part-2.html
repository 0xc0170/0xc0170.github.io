---
layout: post
title: "mbed GCC with eclipse KL25Z (Part 2)"
date: 2013-09-13
comments: true
categories:
 - tutorial
 - mbed
---

<div class='post'>
This is finally the debugging part which I described in one of my comments. There are at least 3 options to debug KL25Z with GCC: <br />CMSIS-DAP with openOCD, external Jlink or openSDA Jlink firmware.<br /><br />CMSIS-DAP is still in a development, according to the site <a href="http://openocd.zylin.com/#/c/1542/">cmsis-dap: add initial cmsis-dap support [openocd.zylin.com]</a>. Thus I went straight to Jlink's options. The last option is the most useful for many users. I will describe to process how to set it and be able to debug your KL25Z with no external parts needed.<br /><br /><b>1. step - download Jlink firmware</b><br />Visit a webpage <a href="http://www.segger.com/opensda.html">SEGGER openSDA Jlink [http://www.segger.com]</a>, there are links on the bottom of the webpage. Be aware of some limitations which are stated there.<br /><br />Download OpenSDA Jlink firmware <a href="http://www.segger.com/admin/uploads/userfiles/file/J-Link/JLink_OpenSDA.zip">http://www.segger.com/admin/uploads/userfiles/file/J-Link/JLink_OpenSDA.zip</a><br /><br /><b>2. step - get serial number of openSDA</b><br />Switch your KL25Z to the bootloader mode (unconnect usb, hold reset button, plug it back in while holding button, release button). Copy there unzipped file JLink_OpenSDA.sda<br />Restart the board, then plug it back to your PC.<br /><br />In case you don't have installed jlink software (gdb, jlink console). Get this program from <a href="http://www.segger.com/jlink-software.html?step=4&amp;file=JLink_412">here</a> which will display the serial number of your openSDA jlink in order to download the jlink software (you need jlink's serial number which we obviously don't know as we don't have external tool).<br /><br /><b>3. step - install JLink software</b><br />Download Jlink firmware here <a href="http://www.segger.com/jlink-software.html">JLink software [http://www.segger.com]</a><br /><br />This will install&nbsp; Jlink configurator, check serial number, type it in the page pasted above and download jlink software.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-zdfRnTYy05E/UjMhDdu-M6I/AAAAAAAAC8o/RMQdGfiqYo4/s1600/jlink_opensda_2.JPG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="197" src="http://2.bp.blogspot.com/-zdfRnTYy05E/UjMhDdu-M6I/AAAAAAAAC8o/RMQdGfiqYo4/s320/jlink_opensda_2.JPG" width="320" /></a></div><br /><br /><br /><br />After installing jlink software,&nbsp; navigate to a jlink's folder in my case <i>c:\Program Files\Segger\JLinkARM_V472a</i>, open JLink.exe program. It will display this warning, check the below button, it won't display today, and press accept.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-7jiPJFXmjrw/UjMhDUjgaBI/AAAAAAAAC8k/_oReSGdQOVU/s1600/jlink_opensda_1.JPG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="254" src="http://2.bp.blogspot.com/-7jiPJFXmjrw/UjMhDUjgaBI/AAAAAAAAC8k/_oReSGdQOVU/s320/jlink_opensda_1.JPG" width="320" /> </a></div>This should be an output if your board is connected and the jlink driver was installed properly:<br />&nbsp; <br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-eyPdrGQTv80/UjMiOARbAnI/AAAAAAAAC84/MJ1UHXWpqOQ/s1600/jlink_opensda_3.JPG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="157" src="http://3.bp.blogspot.com/-eyPdrGQTv80/UjMiOARbAnI/AAAAAAAAC84/MJ1UHXWpqOQ/s320/jlink_opensda_3.JPG" width="320" /></a></div><div class="separator" style="clear: both; text-align: center;"></div>Jlink is connected, we proceed to the eclipse project we created in part 1.<br /><br /><b>4. step - run jlink gdb server</b><br />The program is located again in the Segger Jlink software folder, named JLinkGDBServer. Execute the program, it pops the config window, set it as it is shown on the picture:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-btnU-PZEDWM/UjMpNtc8pMI/AAAAAAAAC90/ZdgLeXZR6aU/s1600/jlink_opensda_9.JPG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="320" src="http://1.bp.blogspot.com/-btnU-PZEDWM/UjMpNtc8pMI/AAAAAAAAC90/ZdgLeXZR6aU/s320/jlink_opensda_9.JPG" width="309" /></a></div>Press OK and it should display the following lines<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-XALOfr_1SkM/UjMpasAqxtI/AAAAAAAAC98/YM4YauEVDPE/s1600/jlink_opensda_10.JPG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="234" src="http://4.bp.blogspot.com/-XALOfr_1SkM/UjMpasAqxtI/AAAAAAAAC98/YM4YauEVDPE/s320/jlink_opensda_10.JPG" width="320" /></a></div>As you see, it's connected to my freedom board. Keep it running, we will connect to it once we complete debug settings in Eclipse.<br /><br /><b>5. step - set eclipse</b> <b>project</b><br />Before going further, your eclipse must have installed <b>GDB Hardware Debugging plugin. </b>If not, please find a tutorial how to install that plugin.<br /><br />Open your mbed KL25Z project, select your project, click on the green bug (the top right corner on the picture) and select <i>Debug configuration</i>.<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-SPGkf7Fal8w/UjMksE4T91I/AAAAAAAAC9E/3bg0QctPHnY/s1600/jlink_opensda_4.JPG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="153" src="http://3.bp.blogspot.com/-SPGkf7Fal8w/UjMksE4T91I/AAAAAAAAC9E/3bg0QctPHnY/s400/jlink_opensda_4.JPG" width="400" /></a></div>Click with your right mouse button on GDB Hardware Debugging, create New one<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/--Yb8Kkr_lv4/UjMmXhylcKI/AAAAAAAAC9Q/WTlkWyJt_sY/s1600/jlink_opensda_5.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="123" src="http://2.bp.blogspot.com/--Yb8Kkr_lv4/UjMmXhylcKI/AAAAAAAAC9Q/WTlkWyJt_sY/s320/jlink_opensda_5.jpg" width="320" /></a></div>On the bottom of the window it is "Using GDB (DSF) Hardware .... <u>Select other</u> . Click on select other and we need to check button Use configuration specific and select Standard GDB Hardware<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-6pUT_3X1AKs/UjMnAU53BWI/AAAAAAAAC9Y/gNSNaa4-s98/s1600/jlink_opensda_6.JPG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="400" src="http://3.bp.blogspot.com/-6pUT_3X1AKs/UjMnAU53BWI/AAAAAAAAC9Y/gNSNaa4-s98/s400/jlink_opensda_6.JPG" width="297" /></a></div>Now we are back in Debug configurations, select Debugger tab and fill details according to the picture below<br /><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-qVwnSrQ73sc/UjMnYKOjZpI/AAAAAAAAC9g/psz3hOTFVko/s1600/jlink_opensda_7.JPG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="220" src="http://4.bp.blogspot.com/-qVwnSrQ73sc/UjMnYKOjZpI/AAAAAAAAC9g/psz3hOTFVko/s320/jlink_opensda_7.JPG" width="320" /></a></div>The tab Startup needs this details<br />The first input window (Initialization Commands) contain on my side the following commands<br /><span style="font-size: x-small;">target remote localhost:2331<br />monitor clrbp<br />monitor endian little<br />monitor speed 1000<br />monitor reset<br />monitor sleep 100<br />monitor speed auto</span><br /><br />The last input window (Run Commands) (Note: I prefer to put a breakpoint in Reset_Handler)<br /><span style="font-size: x-small;">break main<br />continue</span><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-M8mifgwEOoU/UjMoqnRPFTI/AAAAAAAAC9s/FNzRn6ii-GE/s1600/jlink_opensda_8.JPG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="400" src="http://3.bp.blogspot.com/-M8mifgwEOoU/UjMoqnRPFTI/AAAAAAAAC9s/FNzRn6ii-GE/s400/jlink_opensda_8.JPG" width="236" /></a></div>I assume your jlink gdb server is running, click on the debug icon on the bottom of Debug configurations window.<br /><br />This should be your window (breakpoint is set in main, thus it stops there).<br /><br /><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-Hm0PgFGDfyw/UjMuET_pBRI/AAAAAAAAC-I/ipT1dmemoP4/s1600/jlink_opensda_11.JPG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="289" src="http://2.bp.blogspot.com/-Hm0PgFGDfyw/UjMuET_pBRI/AAAAAAAAC-I/ipT1dmemoP4/s320/jlink_opensda_11.JPG" width="320" /></a></div><br />Now led should be blinking.<br /><br />The debugging part over ! There are tutorials how to work with gdb. If anything not correct, please use comments below or contact me on mbed. I'll add this to my notepad there.</div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>karfes</div>
<div class='content'>
CMSIS-DAP is still in a development, but almost in final stages now, its fully working with the patch in this post: http://karibe.co.ke/2013/08/setting-up-linux-opensource-build-and-debug-tools-for-freescale-freedom-board-frdm-kl25z/<br /><br />Great work on mbed,<br />Regards</div>
</div>
</div>
