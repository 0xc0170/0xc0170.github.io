---
layout: post
title: "unlocking kinetis (KL25Z) with the jlink console"
date: 2013-12-03
comments: true
categories:
 - tutorial
 - pyOCD
---

<div class='post'>
I locked my KL25Z board using pyOCD gdb yesterday, was not able to connect to the chip with ULINK, neither with CMSIS-DAP interface on KL25Z (K20). Because I am using older bootloader on openSDA interface, the board does not recognize jlink openSDA binary file. The only option left for me was to test it with an external jlink. So you need an external jlink to follow. I am not aware that ulink can do this. If you are, leave a comment!<br /><br />To start with this, enter to the bootloader mode, if you are using openSDA hardware interface. So no any other interface is active which would block an access to the target.<br /><br />I connected my jlink to it, shown error while connecting to the chip. Usually when I locked kinetis chip, at least jlink was able to connect to MCU. This time I assumed the mass erase protection bit was set. Thus I followed just simple steps find out what is the state of my core. I got lucky, the mass erase bit was not set, jlink was able to unlock the kinetis. If mass erase bit is set, it would fail. I accidentally selected KL26Z chip.<br /><br /><pre class="brush: python">SEGGER J-Link Commander V4.76f ('?' for help)<br />Compiled Sep 27 2013 16:54:08<br />DLL version V4.76f, compiled Sep 27 2013 16:53:51<br />Firmware: J-Link Lite-FSL V1 compiled Jun 25 2012 16:40:07<br />Hardware: V1.00<br />S/N: 361000149<br />VTarget = 2.874V<br />Info: Could not measure total IR len. TDO is constant high.<br />Info: Could not measure total IR len. TDO is constant high.<br />No devices found on JTAG chain. Trying to find device on SWD.<br />Info: Found SWD-DP with ID 0x0BC11477<br /><br />****** Error: Error while identifying Cortex-M core.<br />Info: Found SWD-DP with ID 0x0BC11477<br />No device found on SWD.<br />Failed to identify target. Trying again with slow (4 kHz) speed.<br />Info: Could not measure total IR len. TDO is constant high.<br />Info: Could not measure total IR len. TDO is constant high.<br />No devices found on JTAG chain. Trying to find device on SWD.<br />Info: Found SWD-DP with ID 0x0BC11477<br /><br />****** Error: Error while identifying Cortex-M core.<br />Info: Found SWD-DP with ID 0x0BC11477<br />No device found on SWD.<br /><br />J-Link&gt;device ?<br />Info: Device "MKL26Z128XXX4" selected (128 KB flash, 16 KB RAM).<br />Reconnecting to target...<br />Info: Could not measure total IR len. TDO is constant high.<br />Info: Could not measure total IR len. TDO is constant high.<br />J-Link&gt;unlock kinetis<br />Unlocking device...O.K.</pre><pre class="brush: python">J-Link&gt;SWDReadAP 0x1000000<br />Read AP register 16777216 = 0x00000000<br />J-Link&gt;SWDReadAP 0x1000000<br />Read AP register 16777216 = 0x00000031</pre><pre class="brush: python">J-Link&gt;erase<br />Info: Found SWD-DP with ID 0x0BC11477<br />Info: Found SWD-DP with ID 0x0BC11477<br />Info: Found Cortex-M0 r0p0, Little endian.<br />Info: FPUnit: 2 code (BP) slots and 0 literal slots<br />Info: Kinetis L-series (setup): Disabling watchdog.<br />Erasing device (MKL26Z128xxx4)...<br />Info: J-Link: Flash download: Flash programming performed for 1 range (1024 byte<br />s)<br />Info: J-Link: Flash download: Total time needed: 1.086s (Prepare: 0.465s, Compar<br />e: 0.143s, Erase: 0.017s, Program: 0.047s, Verify: 0.012s, Restore: 0.399s)<br />Erasing done.<br />J-Link&gt;<br /></pre><br />To read further about MDM-AP Control register (check the output SWDReadAP), see chapter 9.3.1 MDM-AP Control Register where all bits are described.<br /><br />Update1:<br />I am testing the KL46Z interface, got locked today, but was not able to revive it with the same procedure as above, unlocking failed firstly. I invoked erase, passed with a error, and the unlock. My chip is again alive!<br /><br /><pre class="brush: python">SEGGER J-Link Commander V4.76f ('?' for help)<br />Compiled Sep 27 2013 16:54:08<br />DLL version V4.76f, compiled Sep 27 2013 16:53:51<br />Firmware: J-Link Lite-FSL V1 compiled Jun 25 2012 16:40:07<br />Hardware: V1.00<br />S/N: 361000149<br />VTarget = 3.280V<br />Info: Could not measure total IR len. TDO is constant high.<br />Info: Could not measure total IR len. TDO is constant high.<br />No devices found on JTAG chain. Trying to find device on SWD.<br />Info: Found SWD-DP with ID 0x0BC11477<br /><br />****** Error: Error while identifying Cortex-M core.<br />Info: Found SWD-DP with ID 0x0BC11477<br />No device found on SWD.<br />Failed to identify target. Trying again with slow (4 kHz) speed.<br />Info: Could not measure total IR len. TDO is constant high.<br />Info: Could not measure total IR len. TDO is constant high.<br />No devices found on JTAG chain. Trying to find device on SWD.<br />Info: Found SWD-DP with ID 0x0BC11477<br /><br />****** Error: Error while identifying Cortex-M core.<br />Info: Found SWD-DP with ID 0x0BC11477<br />No device found on SWD.<br />J-Link&gt;device ?<br />Info: Device "MKL46Z256XXX4 (ALLOW SECURITY)" selected (256 KB flash, 32 KB RAM)<br />.<br />Reconnecting to target...<br />Info: Could not measure total IR len. TDO is constant high.<br />Info: Could not measure total IR len. TDO is constant high.<br />J-Link&gt;unlock kinetis<br />Unlocking device...Timeout while unlocking device.<br />J-Link&gt;unlock kinetis<br />Unlocking device...Timeout while unlocking device.<br />J-Link&gt;unlock kinetis<br />Unlocking device...Timeout while unlocking device.<br />J-Link&gt;erase<br />Info: Found SWD-DP with ID 0x0BC11477<br /><br />****** Error: Kinetis (connect): Timeout while halting CPU. CPU does not stop.<br />Erasing device (MKL46Z256xxx4 (allow security))...<br />Info: Found SWD-DP with ID 0x0BC11477<br />Info: Found SWD-DP with ID 0x0BC11477<br />Info: Found Cortex-M0 r0p0, Little endian.<br />Info: FPUnit: 2 code (BP) slots and 0 literal slots<br />Info: Kinetis L-series (setup): Disabling watchdog.<br />Info: J-Link: Flash download: Flash programming performed for 1 range (1024 byte<br />s)<br />Info: J-Link: Flash download: Total time needed: 1.173s (Prepare: 0.481s, Compar<br />e: 0.245s, Erase: 0.016s, Program: 0.001s, Verify: 0.010s, Restore: 0.417s)<br />Erasing done.<br />J-Link&gt;unlock kinetis<br />Unlocking device...O.K.<br />J-Link&gt;<br /></pre></div>
